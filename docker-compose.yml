services:
   mysql:
      image: mysql:8.0
      container_name: thapargo-mysql
      restart: unless-stopped
      environment:
         MYSQL_ROOT_PASSWORD: viyug132922
         MYSQL_DATABASE: thapargo
         MYSQL_USER: thapargo_user
         MYSQL_PASSWORD: thapargo_pass
      ports:
         - "9000:3306"
      volumes:
         - mysql_data:/var/lib/mysql
      networks:
         - thapargo-network
      command: --default-authentication-plugin=mysql_native_password
      healthcheck:
         test:
            [
               "CMD",
               "mysqladmin",
               "ping",
               "-h",
               "localhost",
               "-u",
               "thapargo_user",
               "-pthapargo_pass",
            ]
         timeout: 20s
         retries: 10
         interval: 10s

   server:
      build:
         context: ./Server
         dockerfile: Dockerfile
      container_name: thapargo-server
      restart: unless-stopped
      ports:
         - "4000:4000"
      environment:
         NODE_ENV: production
         PORT: 4000
         DATABASE_URL: mysql://thapargo_user:thapargo_pass@mysql:3306/thapargo
         JWT_ACCESS_SECRET: your_jwt_access_secret_change_in_production
         MYSQL_HOST: mysql
         MYSQL_PORT: 3306
         MYSQL_USER: thapargo_user
         MYSQL_PASSWORD: thapargo_pass
         MYSQL_DATABASE: thapargo
         FRONTEND_ORIGIN: http://localhost:8080
         TEMP_TOKEN_EXPIRES_IN: 900
         JWT_EXPIRES_IN: 604800
         LOG_LEVEL: info
         GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      depends_on:
         mysql:
            condition: service_healthy
      networks:
         - thapargo-network
      volumes:
         - ./Server:/app
         - /app/node_modules

networks:
   thapargo-network:
      driver: bridge

volumes:
   mysql_data:
      driver: local
